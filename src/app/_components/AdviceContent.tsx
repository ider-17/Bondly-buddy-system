"use client"

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Lightbulb } from 'lucide-react';
import { supabase } from "@/lib/supabase";
import { toast } from "sonner";

const categorizedSteps = {
    career: [
        {
            content: "”®”©—Ä–∏–π–Ω –∑–æ—Ä–∏–ª–≥–æ–æ —Ç–æ–¥–æ—Ä—Ö–æ–π –±–æ–ª–≥–æ. –ë–æ–≥–∏–Ω–æ –±–æ–ª–æ–Ω —É—Ä—Ç —Ö—É–≥–∞—Ü–∞–∞–Ω—ã –∑–æ—Ä–∏–ª—Ç–æ–æ –±–∏—á–∏–∂, –∞–ª—Ö–∞–º –∞–ª—Ö–º–∞–∞—Ä —É—Ä–∞–≥—à–∏–ª üî•",
        },
        {
            content: "–®–∏–Ω—ç –∑“Ø–π–ª–¥ —Å—É—Ä–∞–ª—Ü–∞—Ö–∞–∞—Å –±“Ø“Ø –∞–π. –ê–∂–ª—ã–Ω—Ö–∞–∞ —Ö“Ø—Ä—ç—ç–Ω–¥ —Ö—ç—Ä—ç–≥—Ç—ç–π –Ω—ç–≥ —à–∏–Ω—ç —É—Ä —á–∞–¥–≤–∞—Ä—ã–≥ —Å–æ–Ω–≥–æ–æ–¥ —Å—É—Ä–∞–∞—Ä–∞–πüí°",
        },
        {
            content: "Feedback –±–æ–ª —Ö”©–≥–∂–∏–ª. –£–¥–∏—Ä–¥–ª–∞–≥–∞ –±–æ–ª–æ–Ω –±–∞–≥–∏–π–Ω—Ö–∞–∞ –∑“Ø–≥—ç—ç—Å ”©–≥—Å”©–Ω —Å–∞–Ω–∞–ª —à“Ø“Ø–º–∂–∏–π–≥ –Ω—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø–ª—ç—ç–∂ –∞–≤üí°",
        },
        {
            content: "Portfolio-—Ç–æ–π –∞–∂–∏–ª–ª–∞. –û—Ä–æ–ª—Ü—Å–æ–Ω –∞–∂–ª—É—É–¥–∞–∞ —Ç—ç–º–¥—ç–≥–ª—ç–∂, —Ö–∏–π—Å—ç–Ω –∞–∂–ª–∞–∞ –±–∞—Ä–∏–º—Ç–∂—É—É–ª–∂ —ç—Ö—ç–ªüí°",
        },
        {
            content: "–¢–æ–¥–æ—Ä—Ö–æ–π –±–∞–π–¥–∞–ª –±–æ–ª –∏—Ç–≥—ç–ª —Ç”©—Ä“Ø“Ø–ª–¥—ç–≥. –ß–∏ —é—É —Ö–∏–π–¥—ç–≥, —é—É–Ω–¥ —á–∏–≥–ª—ç–∂ –±–∞–π–≥–∞–∞–≥–∞–∞ –±—É—Å–¥–∞–¥ –æ–π–ª–≥–æ–º–∂—Ç–æ–π –∏–ª—ç—Ä—Ö–∏–π–ª–∂ —Å—É—Äüí°",
        },
    ],
    technical: [
        {
            content: "1% –∏–ª“Ø“Ø –æ–π–ª–≥–æ–ª—Ç ”©–¥”©—Ä –±“Ø—Ä —á–∞–º–∞–π–≥ —Ö–æ–ª —è–≤—É—É–ª–Ω–∞. –ë–∞–≥–∞ –±–∞–≥–∞–∞—Ä —Å—É—Ä–∞–ª—Ü, –∞—Å—É—É—Ö–∞–∞—Å –±“Ø“Ø –∏—áüí°",
        },
        {
            content: "–•—ç—Ä—ç–≥—Ç—ç–π —Ç–æ–≤—á–ª–æ–ª—É—É–¥—ã–≥ —Ç–æ–≥—Ç–æ–æ. ”®–¥”©—Ä —Ç—É—Ç–∞–º –∞—à–∏–≥–ª–∞–¥–∞–≥ –ø—Ä–æ–≥—Ä–∞–º–º—ã–Ω shortcut-—É—É–¥—ã–≥ —Å—É–¥–ª–∞–∞—Ä–∞–πüí°",
        },
        {
            content: "Design –≥–∞—Ä–≥–∞—Ö–¥–∞–∞ “Ø—Ä–≥—ç–ª–∂ —Ç—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–≥–∞–∞—Ä–∞–π. –¢—ç–º–¥—ç–≥–ª—ç–ª –±–æ–ª –æ–π–ª–≥–æ–ª—Ç—ã–Ω –±–∞—Ç–∞–ª–≥–∞–∞üí°",
        },
        {
            content: "–ë—É—Å–¥—ã–Ω —Ö–∏–π—Å—ç–Ω –∑“Ø–π–ª–∏–π–≥ –∑–∞–¥–∞–ª–∂ —Ö–∞—Ä. Code, component, layout –∑—ç—Ä–≥–∏–π–≥ –∑–∞–¥–ª–∞–Ω —à–∏–Ω–∂–ª—ç—Ö –Ω—å —Å—É—Ä–∞–ª—Ü–∞—Ö —Ö–∞–º–≥–∏–π–Ω —Ö—É—Ä–¥–∞–Ω –∞—Ä–≥–∞‚ú®",
        }
    ],
    communication: [
        {
            content: "–°–æ–Ω—Å–æ—Ö –Ω—å –∏–ª“Ø“Ø —á—É—Ö–∞–ª. –ë—É—Å–¥—ã–≥ —Å–∞–π–Ω —Å–æ–Ω—Å–æ—Ö –Ω—å –Ω–∞–π–¥–≤–∞—Ä—Ç–∞–π —Ö–∞—Ä–∏–ª—Ü–∞–∞–Ω—ã —ç—Ö–ª—ç–ª‚ú®",
        },
        {
            content: "–ê—Å—É—É—Ö –Ω—å –±—É—Ä—É—É –±–∏—à. –≠—Ä–≥—ç–ª–∑—ç–∂ –±–∞–π–≥–∞–∞ –∑“Ø–π–ª—ç—ç –∑–æ—Ä–∏–≥—Ç–æ–π –∞—Å—É—É–∂ —Å—É—Ä‚ú®",
        },
        {
            content: "–≠–µ–ª–¥—ç–≥ –±–∞–π–¥–∞–ª –±–æ–ª –º—ç—Ä–≥—ç–∂–ª–∏–π–Ω —É—Ä —á–∞–¥–≤–∞—Ä. –ë–∞—è—Ä–ª–∞–ª–∞–∞, –£—É—á–ª–∞–∞—Ä–∞–π –≥—ç–¥—ç–≥ “Ø–≥—Å–∏–π–≥ ”©–¥”©—Ä —Ç—É—Ç–∞–º —Ö—ç—Ä—ç–≥–ª—ç‚ú®",
        },
        {
            content: "–•“Ø–ª—ç—ç–ª—Ç—ç—ç —Ç–æ–¥–æ—Ä—Ö–æ–π —Ö—ç–ª. –ê–∂–ª—ã–Ω —Ö—É–≥–∞—Ü–∞–∞, —Ö“Ø—Ä–≥—ç—Ö “Ø—Ä –¥“Ø–Ω–≥ —É—Ä—å–¥—á–∏–ª–∂ –∏–ª—ç—Ä—Ö–∏–π–ª—ç—Ö –Ω—å —Ç”©”©—Ä”©–≥–¥–ª”©”©—Å —Å—ç—Ä–≥–∏–π–ª–Ω—çüî•",
        },
        {
            content: "–ó”©—Ä—á–∏–ª “Ø“Ø—Å–≤—ç–ª, —Ç–∞–π–≤–∞–Ω –±–∞–π–∂ —è—Ä–∏–ª—Ü. –•—É–≤–∏–π–Ω –±–∏—à –∞–∂–ª—ã–Ω —à–∞–ª—Ç–≥–∞–∞–Ω—ã–≥ —Ç”©–≤ –±–æ–ª–≥–æ–Ω —Ö–∞–Ω–¥‚ú®",
        },

    ],
    leadership: [
        {
            content: "–•–∞—Ä–∏—É—Ü–ª–∞–≥–∞ –±–æ–ª –º–∞–Ω–ª–∞–π–ª–ª—ã–Ω “Ø–Ω–¥—ç—Å. ”®”©—Ä–∏–π–Ω –∞–∂–ª—ã–≥ ”©”©—Ä”©”© —Ö–∞—Ä–∏—É—Ü–∞–∂ —Å—É—Äüí°",
        },
        {
            content: "–ú–∞–Ω–ª–∞–π–ª–∞–≥—á –±“Ø–≥–¥–∏–π–≥ –º—ç–¥–¥—ç–≥–≥“Ø–π, –∞—Å—É—É–¥–∞–≥. –ë—É—Å–¥–∞–∞—Å —Å—É—Ä–∞–ª—Ü–∞—Ö –∑–æ—Ä–∏–≥—Ç–æ–π –±–∞–πüí°",
        },
        {
            content: "–®–∏–π–¥–≤—ç—Ä –≥–∞—Ä–≥–∞–ª—Ç–∞–¥ –æ—Ä–æ–ª—Ü. –Ø–º–∞—Ä –Ω—ç–≥ –∞—Å—É—É–¥–∞–ª –¥—ç—ç—Ä —Å–∞–Ω–∞–ª, —à–∏–π–¥—ç–ª –≥–∞—Ä–≥–∞–∂ –±–∞–πüí°",
        },
        {
            content: "–ë—É—Å–¥–∞–¥ “Ø–ª–≥—ç—Ä–ª—ç. –•—É–≥–∞—Ü–∞–∞–Ω–¥–∞–∞ –∞–∂–ª–∞–∞ —Ö–∏–π—Ö, —Ö—É—Ä–¥–∞–Ω —Ö–∞—Ä–∏—É ”©–≥”©—Ö –Ω—å ”©”©—Ä”©”© –º–∞–Ω–ª–∞–π–ª–ª—ã–Ω —Ö—ç–ª–±—ç—Ä —é–ºüí°",
        }
    ],
    teamwork: [
        {
            content: "–ù—ç—ç–ª—Ç—Ç—ç–π, –æ–π–ª–≥–æ–º–∂—Ç–æ–π —Ö–∞–Ω–¥. –ú—ç–¥—ç—ç–ª–ª—ç—ç —Ö–∞–∞–ª—Ç—Ç–∞–π –±–∞–π–ª–≥–∞—Ö –Ω—å “Ø–ª –æ–π–ª–≥–æ–ª—Ü–æ–ª–¥ —Ö“Ø—Ä–≥—ç–¥—ç–≥ü§ù",
        },
        {
            content: "–ë—É—Å–¥—ã–Ω –æ—Ä–æ–Ω–¥ ”©”©—Ä–∏–π–≥”©”© —Ç–∞–≤—å–∂ “Ø–∑. Empathy –±–æ–ª —Ö–∞–º—Ç—ã–Ω –∞–∂–∏–ª–ª–∞–≥–∞–∞–Ω—ã —Ç“Ø–ª—Ö“Ø“Ø—Äü§ù",
        },
        {
            content: "–•—É–≤–∞–∞–ª—Ü, —Ç—É—Å–∞–ª. –ß–∏–Ω–∏–π –º—ç–¥–¥—ç–≥ –∑“Ø–π–ª–∏–π–≥ –±—É—Å–¥–∞–¥ –∑–∞–∞–∂ ”©–≥”©—Ö –Ω—å –±–∞–≥–∏–π–≥ ”©—Å–≥”©–¥”©–≥ü§ù",
        },
        {
            content: "–ó–æ—Ä–∏–ª–≥–æ–æ –Ω—ç–≥—Ç–≥—ç. –ë–∞–≥–∞–∞—Ä –∞–∂–∏–ª–ª–∞–∂ –±—É–π –±–æ–ª –±“Ø—Ö –≥–∏—à“Ø“Ø–¥–∏–π–Ω –∑–æ—Ä–∏–ª–≥—ã–≥ –æ–π–ª–≥–æ—Ö—ã–≥ —Ö–∏—á—ç—çü§ù",
        },
        {
            content: "–ê–º–∂–∏–ª—Ç–∞–¥ –Ω—å –±–∞—è—Ä —Ö“Ø—Ä–≥—ç. –ë—É—Å–¥—ã–Ω –∞–º–∂–∏–ª—Ç—ã–≥ “Ø–Ω—ç–ª—ç—Ö –Ω—å –∏—Ç–≥—ç–ª—Ü—ç–ª –±–∏–π –±–æ–ª–≥–æ–¥–æ–≥ü§ù",
        },
    ],
    workupbalance: [
        {
            content: "–ê–∂–ª–∞–∞—Å –≥–∞—Ä—á –∞–º—å—Å–≥–∞–∞ –∞–≤. 5 –º–∏–Ω—É—Ç—ã–Ω –∑–∞–≤—Å–∞—Ä–ª–∞–≥–∞ —Ö“Ø—Ä—Ç—ç–ª —á—É—Ö–∞–ªü´∂",
        },
        {
            content: "–ê–∂–ª—ã–Ω —Ü–∞–≥–∞–∞—Ä –∞–∂–∏–ª–ª–∞, –∞–º—Ä–∞–ª—Ç—ã–Ω —Ü–∞–≥–∞–∞—Ä –∞–º–∞—Ä. –Ø–ª–≥–∞–∞ –∑–∞–∞–≥—Ç–∞–π –±–∞–π—Ö –Ω—å —Å—Ç—Ä–µ—Å—Å –±—É—É—Ä—É—É–ª–¥–∞–≥ü´∂",
        },
        {
            content: "”®”©—Ä–∏–π–≥”©”© —É—Ä–∞–º—à—É—É–ª. –°–∞–π–Ω —Ö–∏–π—Å—ç–Ω –∞–∂–ª—ã–Ω—Ö–∞–∞ –¥–∞—Ä–∞–∞ ”©”©—Ä—Ç”©”© –±–∞–≥–∞—Ö–∞–Ω –±–∞—è—Ä ”©–≥‚ú®",
        },
        {
            content: "“Æ–≥“Ø–π –≥—ç–∂ —Ö—ç–ª–∂ —Å—É—Ä. –ê—á–∞–∞–ª–ª–∞–∞ —Ö—ç—Ç –Ω—ç–º—ç—Ö –Ω—å –±“Ø—Ç—ç—ç–º–∂ –±—É—É—Ä—É—É–ª–∞—Ö —ç—Ä—Å–¥—ç–ª—Ç—ç–πü´∂",
        },
        {
            content: "–•”©–¥”©–ª–≥”©”©–Ω, –∞–º—Ä–∞–ª—Ç –∑—ç—Ä—ç–≥ —á—É—Ö–∞–ª. –ê–∂–∏–ª –¥—ç—ç—Ä –±“Ø—Ç—ç—ç–º–∂—Ç—ç–π –±–∞–π—Ö “Ø–Ω–¥—ç—Å –Ω—å —Å–∞–π–Ω —É–Ω—Ç–∞–∂ –∞–º—Ä–∞—Öüò¥",
        },
    ],
} as const

const categoryLabels: Record<string, string> = {
    all: "–ë“Ø–≥–¥",
    career: "–ö–∞—Ä—å–µ—Ä",
    technical: "–¢–µ—Ö–Ω–∏–∫–∏–π–Ω —É—Ä —á–∞–¥–≤–∞—Ä",
    communication: "–•–∞—Ä–∏–ª—Ü–∞–∞–Ω—ã —á–∞–¥–≤–∞—Ä",
    leadership: "–ú–∞–Ω–ª–∞–π–ª–∞–ª—ã–Ω —É—Ä —á–∞–¥–≤–∞—Ä",
    teamwork: "–ë–∞–≥–∞–∞—Ä –∞–∂–∏–ª–ª–∞—Ö",
    workupbalance: "–ê–∂–∏–ª-–∞–º—å–¥—Ä–∞–ª—ã–Ω —Ç—ç–Ω—Ü–≤—ç—Ä",
}
type Category = keyof typeof categorizedSteps | "all"

export function AdviceContent() {
    const [selectedCategory, setSelectedCategory] = useState<Category>("all")
    const [checkedItems, setCheckedItems] = useState<Record<string, boolean>>({});
    const [loading, setLoading] = useState(false);

    const selectedAdviceList =
        selectedCategory === "all"
            ? Object.entries(categorizedSteps).flatMap(([category, advices]) =>
                advices.map((advice, idx) => ({ ...advice, category, id: `${category}-${idx}` }))
            )
            : categorizedSteps[selectedCategory].map((advice, idx) => ({
                ...advice,
                category: selectedCategory,
                id: `${selectedCategory}-${idx}`,
            }));

    // Fetch read tips on component mount
    useEffect(() => {
        fetchReadTips();
    }, []);

    const fetchReadTips = async () => {
        try {
            const {
                data: { session },
                error: sessionError,
            } = await supabase.auth.getSession();

            if (sessionError || !session) {
                console.error('Session error:', sessionError);
                return;
            }

            const userId = session.user.id;

            const { data: readTips, error } = await supabase
                .from('read_tips')
                .select('tip_id')
                .eq('user_id', userId);

            if (error) {
                console.error('Error fetching read tips:', error);
                return;
            }

            const checkedState: Record<string, boolean> = {};
            readTips?.forEach(tip => {
                checkedState[tip.tip_id] = true;
            });
            
            setCheckedItems(checkedState);
        } catch (error) {
            console.error('Error in fetchReadTips:', error);
        }
    };

    const toggleChecked = async (id: string) => {
        const isCurrentlyChecked = checkedItems[id];
        
        // Update UI immediately for better UX
        setCheckedItems((prev) => ({
            ...prev,
            [id]: !prev[id],
        }));

        try {
            // Record activity for the day
            await recordDailyActivity();

            if (!isCurrentlyChecked) {
                // Mark as read
                await markTipAsRead(id);
                toast.success("–ó”©–≤–ª”©–º–∂ —É–Ω—à—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–≥–¥–ª—ç—ç!");
            } else {
                // Unmark as read
                await unmarkTipAsRead(id);
                toast.success("–ó”©–≤–ª”©–º–∂–∏–π–Ω —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç –∞—Ä–∏–ª–≥–∞–≥–¥–ª–∞–∞");
            }
        } catch (error) {
            console.error('Error toggling tip:', error);
            // Revert UI change on error
            setCheckedItems((prev) => ({
                ...prev,
                [id]: isCurrentlyChecked,
            }));
            toast.error("–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
        }
    };

    const markTipAsRead = async (tipId: string) => {
        const {
            data: { session },
            error: sessionError,
        } = await supabase.auth.getSession();

        if (sessionError || !session) {
            throw new Error("User session not found");
        }

        const userId = session.user.id;
        const category = tipId.split('-')[0];

        const { error } = await supabase
            .from('read_tips')
            .insert({
                user_id: userId,
                tip_id: tipId,
                category: category,
            });

        if (error && error.code !== '23505') { // Ignore duplicate key errors
            console.error('Error marking tip as read:', error);
            throw error;
        }
    };

    const unmarkTipAsRead = async (tipId: string) => {
        const {
            data: { session },
            error: sessionError,
        } = await supabase.auth.getSession();

        if (sessionError || !session) {
            throw new Error("User session not found");
        }

        const userId = session.user.id;

        const { error } = await supabase
            .from('read_tips')
            .delete()
            .eq('user_id', userId)
            .eq('tip_id', tipId);

        if (error) {
            console.error('Error unmarking tip as read:', error);
            throw error;
        }
    };

    const recordDailyActivity = async () => {
        try {
            const {
                data: { session },
                error: sessionError,
            } = await supabase.auth.getSession();

            if (sessionError || !session) {
                console.error('Session error in recordDailyActivity:', sessionError);
                return;
            }

            const userId = session.user.id;
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

            // Insert today's activity (will be ignored if already exists due to unique constraint)
            const { error } = await supabase
                .from('user_activity')
                .insert({
                    user_id: userId,
                    activity_date: today,
                });

            // Ignore unique constraint violations (user already has activity for today)
            if (error && error.code !== '23505') {
                console.error('Error recording daily activity:', error);
            }
        } catch (error) {
            console.error('Error in recordDailyActivity:', error);
        }
    };

    return (
        <div className="space-y-10 space-x-10">
            <div className="w-full flex gap-3 overflow-scroll py-2">
                {(["all", ...Object.keys(categorizedSteps)] as Category[]).map((category) => (
                    <Button
                        key={category}
                        variant={selectedCategory === category ? "default" : "outline"}
                        onClick={() => setSelectedCategory(category)}
                        className="whitespace-nowrap"
                    >
                        {categoryLabels[category] || category}
                    </Button>
                ))}
            </div>

            <div className="flex flex-col gap-5">
                {selectedAdviceList.map((step) => (
                    <div
                        key={step.id}
                        className="w-full py-5 px-6 space-y-3 border border-neutral-300 rounded-xl flex items-center justify-between gap-4 bg-white"
                    >
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 flex items-center justify-center bg-orange-100 rounded-lg">
                                <Lightbulb size={18} color="#EA580C" />
                            </div>

                            <div>
                                <p className="text-wrap text-sm font-medium">
                                    {step.content}
                                </p>
                                <button className="py-1 px-[10px] bg-gray-100 rounded-full text-xs font-medium mt-2">
                                    {categoryLabels[step.category] || step.category}
                                </button>
                            </div>
                        </div>

                        <div className="inline-block relative">
                            <input
                                type="checkbox"
                                id={step.id}
                                checked={!!checkedItems[step.id]}
                                onChange={() => toggleChecked(step.id)}
                                className="peer absolute opacity-0 w-5 h-5 text-white"
                                disabled={loading}
                            />
                            <label
                                htmlFor={step.id}
                                className="flex items-center justify-center w-5 h-5 rounded border border-gray-300 cursor-pointer
               peer-checked:bg-green-500 peer-checked:border-green-500 relative transition-colors duration-200
               hover:border-green-400 peer-disabled:cursor-not-allowed peer-disabled:opacity-50"
                            >
                                <svg 
                                    width="12" 
                                    height="9" 
                                    viewBox="0 0 12 9" 
                                    fill="none" 
                                    xmlns="http://www.w3.org/2000/svg"
                                    className={`transition-opacity duration-200 ${checkedItems[step.id] ? 'opacity-100' : 'opacity-0'}`}
                                >
                                    <path 
                                        fillRule="evenodd" 
                                        clipRule="evenodd" 
                                        d="M11.8047 0.528758C12.0651 0.789108 12.0651 1.21122 11.8047 1.47157L4.4714 8.8049C4.21105 9.06525 3.78894 9.06525 3.5286 8.8049L0.195262 5.47157C-0.0650874 5.21122 -0.0650874 4.78911 0.195262 4.52876C0.455612 4.26841 0.877722 4.26841 1.13807 4.52876L4 7.39069L10.8619 0.528758C11.1223 0.268409 11.5444 0.268409 11.8047 0.528758Z" 
                                        fill="white" 
                                    />
                                </svg>
                            </label>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}